<!DOCTYPE html>
<html>
<head>
<title>Portfolio Items Tree Grid</title>

<script type="text/javascript"
	src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

<script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.common.PortfolioItemsGridBoardApp",{extend:"Rally.app.GridBoardApp",requires:["Rally.ui.cardboard.plugin.CollapsibleColumns","Rally.ui.cardboard.plugin.FixedHeader"],launch:function(){Rally.environment.getContext().getSubscription().isModuleEnabled("Rally Portfolio Manager")?this.callParent(arguments):(this.add({xtype:"container",html:'<div class="rpm-turned-off" style="padding: 50px; text-align: center;">You do not have RPM enabled for your subscription</div>'}),this.publishComponentReady())},loadModelNames:function(){return this._createPITypePicker().then({success:function(selectedType){return this.currentType=selectedType,[selectedType.get("TypePath")]},scope:this})},addGridBoard:function(){this.gridboard&&this.piTypePicker&&this.piTypePicker.rendered&&this.piTypePicker.up().remove(this.piTypePicker,!1),this.callParent(arguments)},getHeaderControls:function(){return this.callParent(arguments).concat(this.piTypePicker)},getFilterControlConfig:function(){return{blackListFields:["PortfolioItemType"],whiteListFields:["Milestones"]}},getFieldPickerConfig:function(){var blackListedFields=[];return this.getContext().isFeatureEnabled("S74502_PI_DEPENDENCIES_ON_EDP")||blackListedFields.push("PredecessorsAndSuccessors"),_.merge(this.callParent(arguments),{boardFieldDefaults:(this.getSetting("fields")||"").split(","),boardFieldBlackList:["Predecessors","Successors"].concat(blackListedFields),gridFieldBlackList:blackListedFields,margin:"3 9 14 0"})},getCardBoardColumns:function(){return this._getStates().then({success:function(states){return this._buildColumns(states)},scope:this})},_buildColumns:function(states){if(!states.length)return void 0;var columns=[{columnHeaderConfig:{headerTpl:"No Entry"},value:null,plugins:["rallycardboardcollapsiblecolumns"].concat(this.getCardBoardColumnPlugins(null))}];return columns.concat(_.map(states,function(state){return{value:state.get("_ref"),wipLimit:state.get("WIPLimit"),enableWipLimit:!0,columnHeaderConfig:{record:state,fieldToDisplay:"Name",editable:!1},plugins:["rallycardboardcollapsiblecolumns"].concat(this.getCardBoardColumnPlugins(state))}},this))},_getStates:function(){var deferred=new Deft.Deferred;return Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("State"),context:this.getContext().getDataContext(),autoLoad:!0,fetch:["Name","WIPLimit","Description"],filters:[{property:"TypeDef",value:this.currentType.get("_ref")},{property:"Enabled",value:!0}],sorters:[{property:"OrderIndex",direction:"ASC"}],listeners:{load:function(store,records){deferred.resolve(records)}}}),deferred.promise},getCardBoardColumnPlugins:function(state){return[]},getCardConfig:function(){return{}},getCardBoardConfig:function(options){options=options||{};var currentTypePath=this.currentType.get("TypePath"),filters=[];if(this.getSetting("query"))try{filters.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query")))}catch(e){Rally.ui.notify.Notifier.showError({message:e.message})}return{attribute:"State",cardConfig:_.merge({editable:!0,showColorIcon:!0},this.getCardConfig()),columnConfig:{xtype:"rallycardboardcolumn",enableWipLimit:!0},columns:options.columns,ddGroup:currentTypePath,listeners:{load:this.publishComponentReady,cardupdated:this._publishContentUpdatedNoDashboardLayout,scope:this},plugins:[{ptype:"rallyfixedheadercardboard"}],storeConfig:{filters:filters,context:this.getContext().getDataContext()}}},getGridStoreConfig:function(){return{models:this.piTypePicker.getAllTypeNames()}},_createPITypePicker:function(){this.piTypePicker&&this.piTypePicker.destroy();var deferred=new Deft.Deferred;return this.piTypePicker=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{preferenceName:"portfolioitems"+this.stateName+"-typepicker",value:this.getSetting("type"),context:this.getContext(),listeners:{change:this._onTypeChange,ready:{fn:function(picker){deferred.resolve(picker.getSelectedType())},single:!0},scope:this}}),deferred.promise},_onTypeChange:function(picker){var newType=picker.getSelectedType();this._pickerTypeChanged(picker)&&(this.currentType=newType,this.modelNames=[newType.get("TypePath")],this.gridboard.fireEvent("modeltypeschange",this.gridboard,[newType]))},_pickerTypeChanged:function(picker){var newType=picker.getSelectedType();return newType&&this.currentType&&newType.get("_ref")!==this.currentType.get("_ref")},_publishContentUpdatedNoDashboardLayout:function(){this.fireEvent("contentupdated",{dashboardLayout:!1})}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfolioitemstreegrid.PortfolioItemsTreeGridApp",{extend:"Rally.apps.common.PortfolioItemsGridBoardApp",mixins:["Rally.clientmetrics.ClientMetricsRecordable"],requires:["Rally.ui.gridboard.plugin.GridBoardActionsMenu","Rally.ui.grid.TreeGridPrintDialog","Rally.ui.dialog.CsvImportDialog","Rally.ui.grid.GridCsvExport"],componentCls:"pitreegrid",printHeaderLabel:"Portfolio Items",statePrefix:"portfolio-tree",toggleState:"grid",getGridConfig:function(options){var config=this.callParent(arguments),isBufferedRendererEnabled=this.getContext().isFeatureEnabled("S78545_ENABLE_BUFFERED_RENDERER_FOR_PI_PAGE");return config.bufferedRenderer=isBufferedRendererEnabled,config.expandAllInColumnHeaderEnabled=!Ext.isIE||isBufferedRendererEnabled,config.enableInlineAdd=!0,config}})})();

            Rally.launchApp('Rally.apps.portfolioitemstreegrid.PortfolioItemsTreeGridApp', {
                name:"Portfolio Items Tree Grid",
	            parentRepos:""
            });

        });
    </script>


<style type="text/css">
</style>
</head>
<body>
</body>
</html>

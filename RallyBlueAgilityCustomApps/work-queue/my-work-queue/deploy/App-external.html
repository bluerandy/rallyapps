<!DOCTYPE html>
<html>
<head>
<title>My Work Queue</title>

<script type="text/javascript"
	src="https://rallyonprem.sys.cigna.com/apps/2.0rc3/sdk.js"></script>

<script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("MyWorkQueue",{extend:"Rally.app.App",mixins:["Rally.Messageable"],componentCls:"app",launch:function(){this.subscribe(this,"timeboxReleaseChanged",this._releaseChanged,this),this.subscribe(this,"timeboxIterationChanged",this._iterationChanged,this);var me=this;null===this.currentTimebox&&this.publish("requestTimebox",this)},_updateBoard:function(portfolioTimeboxFilter,storyTimeboxFilter){var me=this,field_names=["Name","State","FormattedID","PortfolioItemType","ScheduleState"],base_filter=Ext.create("Rally.data.wsapi.Filter",{property:"Owner",value:this.getContext().getUser()._ref}),ss_filter=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"<",value:"Accepted"}),state_filter=Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"<",value:"Completed"}),stateAndTimeFilter=state_filter.and(storyTimeboxFilter),portfolio_filter=Ext.create("Rally.data.wsapi.Filter",{property:"State.Name",operator:"!=",value:"Done"}),p_filter=portfolio_filter.and(portfolioTimeboxFilter),s_filter=ss_filter.and(storyTimeboxFilter),queries_to_run={Defect:s_filter,Task:stateAndTimeFilter,PortfolioItem:p_filter,HierarchicalRequirement:s_filter},promises=[];Ext.Object.each(queries_to_run,function(model_name,add_filter){var p=function(){return me._loadAStoreWithAPromise(model_name,field_names,base_filter.and(add_filter))};promises.push(p)}),Deft.Chain.sequence(promises).then({scope:this,success:function(results){var records=Ext.Array.flatten(results);Ext.Array.each(records,function(record){record.get("ScheduleState")?record.set("__State",record.get("ScheduleState")):record.get("PortfolioItemType")?record.set("__State",record.get("State.Name")):record.set("__State",record.get("State"))});var store=Ext.create("Rally.data.custom.Store",{data:records});this._displayGrid(store,field_names)},failure:function(error_message){alert(error_message)}}).always(function(){me.setLoading(!1)})},_loadAStoreWithAPromise:function(model_name,model_fields,filters){var deferred=Ext.create("Deft.Deferred"),me=this;return Ext.create("Rally.data.wsapi.Store",{model:model_name,fetch:model_fields,filters:filters}).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise},_displayGrid:function(store,field_names){this.remove("workqueue"),this.add({xtype:"rallygrid",itemId:"workqueue",enableBulkEdit:!0,store:store,sorters:{property:"Rank",direction:"ASC"},columnCfgs:[{text:"ID",dataIndex:"FormattedID",width:100,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",width:400,dataIndex:"Name"},{text:"State",dataIndex:"__State"}]})},_releaseChanged:function(release){if(null===this.currentTimebox||release.get("Name")!=this.currentTimebox.get("Name")){this.currentTimebox=release;var releaseStartFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlannedEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(release.get("ReleaseStartDate"))}),releaseEndFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlannedEndDate",operator:"<=",value:Rally.util.DateTime.toIsoString(release.get("ReleaseDate"))}),portfolioTimeboxFilter=releaseEndFilter.and(releaseStartFilter),storyFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:release.get("Name")});this.getContext().setTimeboxScope(release,"release"),this._updateBoard(portfolioTimeboxFilter,storyFilter)}},_iterationChanged:function(iteration){if(null===this.currentTimebox||iteration.get("Name")!=this.currentTimebox.get("Name")){this.currentTimebox=iteration;var iterationStartFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlannedEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(iteration.get("StartDate"))}),iterationEndFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlannedEndDate",operator:"<=",value:Rally.util.DateTime.toIsoString(iteration.get("EndDate"))}),portfolioTimeboxFilter=iterationStartFilter.and(iterationEndFilter),storyFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",value:iteration.get("Name")});this.getContext().setTimeboxScope(iteration,"iteration"),this._updateBoard(portfolioTimeboxFilter,storyFilter)}}});
                Ext.define("GridExporter",{dateFormat:"Y-m-d g:i",exportGrid:function(grid){if(Ext.isIE)this._ieToExcel(grid);else{var data=this._getCSV(grid);window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)}},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData){var text;return text=null===fieldData||void 0===fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData.match?fieldData:""},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="",that=this;return Ext.Array.each(cols,function(col,index){col.hidden!==!0&&(data+=that._getFieldTextAndEscape(col.text)+",")}),data+="\n",store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,index){if(col.hidden!==!0){var fieldName=col.dataIndex,text=entry[fieldName];data+=that._getFieldTextAndEscape(text)+","}}),data+="\n"}),data},_ieGetGridData:function(grid,sheet){var that=this,resourceItems=grid.store.data.items,cols=grid.columns;Ext.Array.each(cols,function(col,colIndex){col.hidden!==!0&&(console.log("header: ",col.text),sheet.cells(1,colIndex+1).value=col.text)});var rowIndex=2;grid.store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,colIndex){if(col.hidden!==!0){var fieldName=col.dataIndex,text=entry[fieldName],value=that._getFieldText(text);sheet.cells(rowIndex,colIndex+1).value=value}}),rowIndex++})},_ieToExcel:function(grid){if(window.ActiveXObject){var xlApp,xlBook;try{xlApp=new ActiveXObject("Excel.Application"),xlBook=xlApp.Workbooks.Add()}catch(e){return Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."'),void 0}xlBook.worksheets("Sheet1").activate();var XlSheet=xlBook.activeSheet;xlApp.visible=!0,this._ieGetGridData(grid,XlSheet),XlSheet.columns.autofit()}}});

            Rally.launchApp('MyWorkQueue', {
                name:"My Work Queue",
	            parentRepos:"sficarrotta/Multi-item-grid"
            });

        });
    </script>


<style type="text/css">
</style>
</head>
<body>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<title>Field Maintenance</title>

<script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

<script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("field-maintenance",{extend:"Rally.app.App",requires:["Rally.ui.gridboard.plugin.GridBoardFieldPicker"],componentCls:"app",launch:function(){var me=this,field_names=["Name","State","FormattedID","PortfolioItemTypeName","PlannedStartDate","PlannedEndDate","AcceptanceCriteria","Release","Iteration","Owner.UserName","Parent","Feature","c_ValueMetricKPI","Blocked","BlockedReason","ScheduleState"],no_owner=Ext.create("Rally.data.wsapi.Filter",{property:"Owner",value:null}),no_acceptance=Ext.create("Rally.data.wsapi.Filter",{property:"c_AcceptanceCriteria",value:null}),no_iteration=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",value:null}),iteration_exists=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operation:"!=",value:null}),no_release=Ext.create("Rally.data.wsapi.Filter",{property:"Release",value:null}),release_exists=Ext.create("Rally.data.wsapi.Filter",{property:"Release",operation:"!=",value:null}),no_parent=Ext.create("Rally.data.wsapi.Filter",{property:"Parent",value:null}),no_parent_feature=Ext.create("Rally.data.wsapi.Filter",{property:"Feature",value:null}),no_portfolio_metric_filter=Ext.create("Rally.data.wsapi.Filter",{property:"c_ValueMetricKPI",value:null}),no_story_metric_filter=Ext.create("Rally.data.wsapi.Filter",{property:"c_StoryValueMetricKPI",value:null}),blocked=Ext.create("Rally.data.wsapi.Filter",{property:"Blocked",value:!0}),no_blocked_reason=Ext.create("Rally.data.wsapi.Filter",{property:"BlockedReason",value:null}),is_feature=Ext.create("Rally.data.wsapi.Filter",{property:"PortfolioItemType.Name",value:"Feature"}),no_planned_start=Ext.create("Rally.data.wsapi.Filter",{property:"PlannedStartDate",value:null}),no_planned_end=Ext.create("Rally.data.wsapi.Filter",{property:"PlannedEndDate",value:null}),no_owner_story_filter=no_owner.and(iteration_exists),no_blocked_reason_filter=blocked.and(no_blocked_reason),no_release_filter=iteration_exists.and(no_release),no_acceptance_criteria_filter=iteration_exists.and(no_acceptance),no_parent_for_story_filter=no_parent.and(no_parent),no_parent_for_portfolio_filter=is_feature.and(no_parent),story_filter=no_owner_story_filter.or(no_blocked_reason_filter).or(no_release_filter).or(no_acceptance_criteria_filter).or(no_parent_for_story_filter).or(no_story_metric_filter),portfolio_filter=no_owner.or(no_portfolio_metric_filter).or(no_parent_for_portfolio_filter).or(no_planned_end).or(no_planned_start),queries_to_run={PortfolioItem:portfolio_filter,HierarchicalRequirement:story_filter};console.log("Queries made...");var promises=[];Ext.Object.each(queries_to_run,function(model_name,add_filter){var p=function(){return console.log("Loading "+model_name),me._loadAStoreWithAPromise(model_name,field_names,add_filter)};promises.push(p)}),Deft.Chain.sequence(promises).then({scope:this,success:function(results){console.log("Processing results");var records=Ext.Array.flatten(results),finalRecords=[];Ext.Array.each(records,function(record){var issueCount=0,issue="";null===record.get("Owner")&&(issue+="<li>No Owner set</li>",issueCount++),this._isEmpty(record.get("c_ValueMetricKPI"))&&(issue+="<li>No Value Metric defined</li>",issueCount++),record.get("Blocked")===!0&&this._isEmpty(record.get("BlockedReason"))&&(issue+="<li>No Blocked Reason</li>",issueCount++),record.get("PortfolioItemTypeName")?(record.set("__Type",record.get("PortfolioItemTypeName")),"Feature"==record.get("PortfolioItemTypeName")&&this._isEmpty(record.get("Parent"))&&(issue+="<li>No Parent</li>",issueCount++),this._isEmpty(record.get("PlannedStartDate"))&&(issue+="<li>No Planned Start Date</li>",issueCount++),this._isEmpty(record.get("PlannedEndDate"))&&(issue+="<li>No Planned End Date</li>",issueCount++)):(record.set("__Type","User Story"),this._isEmpty(record.get("Iteration"))&&this._isEmpty(record.get("Release"))&&(issue+="<li>No Release defined</li>",issueCount++),this._isEmpty(record.get("c_AcceptanceCriteria"))&&(issue+="<li>No Acceptance Criteria</li>",issueCount++),this._isEmpty(record.get("Parent"))&&this._isEmpty(record.get("Feature"))&&(issue+="<li>No Parent</li>",issueCount++)),issueCount>0&&(issue="<ul>"+issue+"</ul>",record.set("__Issue",issue),record.set("__IssueCount",issueCount),finalRecords.push(record))});var store=Ext.create("Rally.data.custom.Store",{data:finalRecords,sorters:{property:"__IssueCount",direction:"DESC"}});this._displayGrid(store,field_names)},failure:function(error_message){alert(error_message)}}).always(function(){me.setLoading(!1)})},_isEmpty:function(record){return _isNull(record)||_isUndefined(record)},_loadAStoreWithAPromise:function(model_name,model_fields,filters){var deferred=Ext.create("Deft.Deferred"),me=this;return Ext.create("Rally.data.wsapi.Store",{model:model_name,fetch:model_fields,filters:filters}).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise},_displayGrid:function(store,field_names){this.add({xtype:"rallygrid",enableBulkEdit:!0,store:store,columnCfgs:[{text:"ID",dataIndex:"FormattedID",width:100,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{width:400,dataIndex:"Name"},{text:"Owner",dataIndex:"Owner.UserName"},{text:"Issue(s)",width:200,dataIndex:"__Issue"}]})}});

            Rally.launchApp('field-maintenance', {
                name:"Field Maintenance",
	            parentRepos:"sficarrotta/Multi-item-grid"
            });

        });
    </script>


<style type="text/css">
</style>
</head>
<body>
</body>
</html>

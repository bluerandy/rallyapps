<!DOCTYPE html>
<html>
<head>
    <title>wip-limits</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("wip-limits",{extend:"Rally.app.App",mixins:["Rally.Messageable"],launch:function(){this._updateBoard()},_updateBoard:function(portfolioTimeboxFilter,storyTimeboxFilter){var store=Ext.create("Rally.data.wsapi.Store",{model:"hierarchicalrequirement",fetch:["Name","FormattedID","Project","ScheduleState"],limit:1/0});store.on("load",this._onStoriesLoaded,this),store.load()},_onStoriesLoaded:function(store,stories){var me=this,projectGroup=_.groupBy(stories,function(t){return t.get("Project")?t.get("Project")._refObjectName:"none"}),summaries=_.map(_.keys(projectGroup),function(project){var stories=projectGroup[project];this.currentProject=project;var counts=_.countBy(stories,function(story){return story.get("ScheduleState")}),values={},states=["Backlog","Defined","In-Progress","Completed","Accepted"];return _.each(states,function(state){values[state]=_.isUndefined(counts[state])?0:counts[state],console.log("Getting wip: ",project,state);var wip=this._getWipLimit(project,state),wipKey=state+"WIP";null!==wip&&void 0!==wip?(console.log("wipKey: "+wipKey,"wip: ",wip),values[wipKey]=wip):values[wipKey]=0},me),values.project=this.currentProject,values},this),newStore=Ext.create("Rally.data.custom.Store",{data:summaries,sorters:{property:"project",direction:"ASC"}});newStore.addListener("update",function(store,record,op,fieldNames,eOpts){if("edit"==op){console.log("rec:",op,record,fieldNames);var project=record.get("project"),fieldName=_.first(fieldNames),value=record.get(fieldName);console.log("Writing project: "+project+"  field: "+fieldName+"  value: "+value),me._setWipLimit(project,fieldName,value)}},store,{single:!0}),this._displayGrid(newStore)},_displayGrid:function(store){var that=this;this.remove("workqueue"),this.add({xtype:"rallygrid",itemId:"workqueue",enablebulkeditable:!0,enableEditing:!0,store:store,columnCfgs:[{text:"Project",dataIndex:"project",width:250,align:"center"},{text:"Defined",dataIndex:"Defined",renderer:that.renderLimit,align:"center"},{text:"Defined Limit",dataIndex:"DefinedWIP",editor:{xtype:"textfield"},align:"center"},{text:"In-Progress",dataIndex:"In-Progress",renderer:that.renderLimit,align:"center"},{text:"In-Progress Limit",dataIndex:"In-ProgressWIP",editor:{xtype:"textfield"},align:"center"},{text:"Completed",dataIndex:"Completed",renderer:that.renderLimit,align:"center"},{text:"Completed Limit",dataIndex:"CompletedWIP",editor:{xtype:"textfield"},align:"center"}]})},renderLimit:function(value,meta,record,row,col,store,gridView){var field=null;switch(col){case 2:field="DefinedWIP";break;case 4:field="In-ProgressWIP";break;case 6:field="CompletedWIP"}return value>record.get(field)&&(meta.tdCls="over-limit"),value},_setWipLimit:function(project,state,limit){var key=this._getWipKey(project,state),settings={};settings[key]=Ext.JSON.encode(limit),console.log("Setting wip limit of "+limit+" for project: "+project,settings),Rally.data.PreferenceManager.update({workspace:this.getContext().getWorkspace(),settings:settings,scope:this}).then({success:function(updatedRecords,notUpdatedRecord,options){console.log("preference update success",updatedRecords,notUpdatedRecord,options)},failure:function(){console.log("Failed to write preference: ",key,settings)}})},_getWipKey:function(project,state){return"project-wip:"+project+":"+state},_getWipLimit:function(project,state){console.log("Getting wip limit for project: "+project);var key=this._getWipKey(project,state);Rally.data.PreferenceManager.load({workspace:this.getContext().getWorkspace(),filterByName:key}).then({success:function(prefs){if(console.log("prefs:",prefs,"prefs[key]: ",prefs[key]),prefs&&prefs[key]){var values=Ext.JSON.decode(prefs[key]);return values}},failure:function(){console.log("Failed to get WIP limit: ",key)}})}});

            Rally.launchApp('wip-limits', {
                name:"wip-limits",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .over-limit{background-color:red !important;color:white;font-weight:bold}
    </style>
</head>
<body>
</body>
</html>

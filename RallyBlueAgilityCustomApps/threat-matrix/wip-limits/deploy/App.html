<!DOCTYPE html>
<html>
<head>
    <title>wip-limits</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("wip-limits",{extend:"Rally.app.App",mixins:["Rally.Messageable"],launch:function(){this._updateBoard()},_updateBoard:function(portfolioTimeboxFilter,storyTimeboxFilter){var me=this,model=Rally.data.ModelFactory.getModel({type:"UserStory",scope:this}),store=Ext.create("Rally.data.wsapi.Store",{model:"hierarchicalrequirement",fetch:["Name","FormattedID","Project","ScheduleState"],limit:1/0});store.on("load",this._onStoriesLoaded,this),store.load()},_onStoriesLoaded:function(store,stories){var wip_test=[],tmp={project:"ACP","In-Progress":10,Completed:5};wip_test.push(tmp);var g=_.groupBy(stories,function(t){return t.get("Project")?t.get("Project")._refObjectName:"none"}),summaries=_.map(_.keys(g),function(key){var stories=g[key],counts=_.countBy(stories,function(story){return story.get("ScheduleState")}),values={},states=["Backlog","Defined","In-Progress","Completed","Accepted"];return _.each(states,function(state){values[state]=_.isUndefined(counts[state])?0:counts[state];var wip=this._getWipLimit(key,state);console.log("Got WIP: ",wip);var wipKey=state+"WIP";values[wipKey]=null!==wip?wip:0}),values.project=key,values});console.log("Summaries: ",summaries);var newStore=Ext.create("Rally.data.custom.Store",{data:summaries,listeners:{update:function(store,record,op,fieldNames,eOpts){console.log("rec:",op,record,fieldNames);var project=record.get("project"),state;this._setWipLimit(project,state,op)}}});this._displayGrid(newStore)},_displayGrid:function(store){var that=this;this.remove("workqueue"),this.add({xtype:"rallygrid",itemId:"workqueue",enablebulkeditable:!0,enableEditing:!0,store:store,columnCfgs:[{text:"Project",dataIndex:"project"},{text:"Defined",dataIndex:"Defined",renderer:that.renderLimit},{text:"Defined Limit",dataIndex:"DefinedWIP",editor:{xtype:"textfield"}},{text:"In-Progress",dataIndex:"In-Progress",renderer:that.renderLimit},{text:"In-Progress Limit",dataIndex:"In-ProgressWIP",editor:{xtype:"textfield"}},{text:"Completed",dataIndex:"Completed",renderer:that.renderLimit},{text:"Completed Limit",dataIndex:"CompletedWIP",editor:{xtype:"textfield"}}]})},renderLimit:function(value,meta,record,row,col,store,gridView){console.log("Row: "+row+"  col: "+col,"Value: "+value,"Record: ",record);var field=null;switch(col){case 2:field="defined-wip";break;case 4:field="in-progress-wip";break;case 6:field="completed-wip"}return console.log("Value: "+value+"  limit: "+record.get(field)),value>record.get(field)&&(console.log("setting meta: ",meta),meta.tdCls="over-limit"),value},_setWipLimit:function(project,state,limit){settings["project-wip:"+project+":"+state]=Ext.JSON.Encode(limit),console.log("Setting wip limit of "+limit+" for project: "+project),Rally.data.PreferenceManager.update({workspace:this.getContext().getWorkspace(),settings:settings,scope:this,success:function(updatedRecords,notUpdatedRecord,options){me.console.log("success",me.getContext().getWorkspace(),updatedRecords,notUpdatedRecord,options)}})},_getWipLimit:function(project,state){console.log("Getting wip limit for project: "+project),Rally.data.PreferenceManager.load({workspace:this.getContext().getWorkspace(),filterByName:"project-wip:"+project+":"+state,success:function(prefs){if(this.console.log("prefs",prefs),prefs&&prefs[key]){var values=Ext.JSON.decode(prefs[key]);return console.console.log(values),values}}})}});

            Rally.launchApp('wip-limits', {
                name:"wip-limits",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .over-limit{background-color:red}
    </style>
</head>
<body>
</body>
</html>

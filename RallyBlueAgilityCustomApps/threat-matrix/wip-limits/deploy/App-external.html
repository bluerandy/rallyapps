<!DOCTYPE html>
<html>
<head>
    <title>wip-limits</title>

    <script type="text/javascript" src="https://rallyonprem.sys.cigna.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("wip-limits",{extend:"Rally.app.App",mixins:["Rally.Messageable"],launch:function(){this._updateBoard()},_updateBoard:function(portfolioTimeboxFilter,storyTimeboxFilter){var store=Ext.create("Rally.data.wsapi.Store",{model:"hierarchicalrequirement",fetch:["Name","FormattedID","Project","ScheduleState"],limit:1/0});store.on("load",this._onStoriesLoaded,this),store.load()},_onStoriesLoaded:function(store,stories){var me=this,projectGroup=_.groupBy(stories,function(t){return t.get("Project")?t.get("Project")._refObjectName:"none"}),summaries=_.map(_.keys(projectGroup),function(project){var stories=projectGroup[project];this.currentProject=project;var counts=_.countBy(stories,function(story){return story.get("ScheduleState")}),values={},states=["Backlog","Defined","In-Progress","Completed","Accepted"];return _.each(states,function(state){values[state]=_.isUndefined(counts[state])?0:counts[state],console.log("Getting wip: ",project,state);var wip=this._getWipLimit(project,state),wipKey=state+"WIP";null!==wip?(console.log("wipKey: "+wipKey,"wip: ",wip),values[wipKey]=wip):values[wipKey]=0},me),values.project=this.currentProject,values},this);console.log("Summaries: ",summaries);var newStore=Rally.data.custom.Store.create({data:summaries,context:this.getContext(),listeners:{update:function(store,record,op,fieldNames,eOpts){console.log("rec:",op,record,fieldNames);var project=record.get("project"),fieldName=fieldNames[0],value=record.get(fieldName);console.log("Writing project: "+project+"  field: "+fieldName+"  value: "+value),this._setWipLimit(project,fieldName,value)}}},me);this._displayGrid(newStore)},_displayGrid:function(store){var that=this;this.remove("workqueue"),this.add({xtype:"rallygrid",itemId:"workqueue",enablebulkeditable:!0,enableEditing:!0,store:store,columnCfgs:[{text:"Project",dataIndex:"project",align:"center"},{text:"Defined",dataIndex:"Defined",renderer:that.renderLimit,align:"center"},{text:"Defined Limit",dataIndex:"DefinedWIP",editor:{xtype:"textfield"},align:"center"},{text:"In-Progress",dataIndex:"In-Progress",renderer:that.renderLimit,align:"center"},{text:"In-Progress Limit",dataIndex:"In-ProgressWIP",editor:{xtype:"textfield"},align:"center"},{text:"Completed",dataIndex:"Completed",renderer:that.renderLimit,align:"center"},{text:"Completed Limit",dataIndex:"CompletedWIP",editor:{xtype:"textfield"},align:"center"}]})},renderLimit:function(value,meta,record,row,col,store,gridView){console.log("Row: "+row+"  col: "+col,"Value: "+value,"Record: ",record);var field=null;switch(col){case 2:field="DefinedWIP";break;case 4:field="In-ProgressWIP";break;case 6:field="CompletedWIP"}return console.log("Value: "+value+"  limit: "+record.get(field)),value>record.get(field)&&(console.log("setting meta: ",meta),meta.tdCls="over-limit"),value},_setWipLimit:function(project,state,limit){var key=this._getWipKey(project,state);console.log("Setting wip limit of "+limit+" for project: "+project),Rally.data.PreferenceManager.update({workspace:this.getContext().getWorkspace(),settings:{project:project,state:state},scope:this}).then({success:function(updatedRecords,notUpdatedRecord,options){me.console.log("success",this.getContext().getWorkspace(),updatedRecords,notUpdatedRecord,options)}})},_getWipKey:function(project,state){return"project-wip:"+project+":"+state},_getWipLimit:function(project,state){console.log("Getting wip limit for project: "+project);var key=this._getWipKey(project,state);Rally.data.PreferenceManager.load({workspace:this.getContext().getWorkspace(),filterByName:key}).then({success:function(prefs){if(console.log("prefs:",prefs,"prefs[key]: ",prefs[key]),prefs&&prefs[key]){var values=prefs[key];return values}}})}});

            Rally.launchApp('wip-limits', {
                name:"wip-limits",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .over-limit{background-color:red !important;color:white;font-weight:bold}
    </style>
</head>
<body>
</body>
</html>
